---
title: 视频解封装，解码，图像转换流程
date: 2021-03-17 18:28:13
tags:
 - ffmepg
 - qt
---
# 视频解封装，解码，图像转换流程
## AVFormat：封装、解封装、包含协议封装
### 解封装
```shell
1. avformat_alloc_context 	#封装结构体分配内存 // 可以不调用，avformat_open_input会判断入参是否为NULL，自行分配
2. avformat_open_input     	#打开输入文件用于读取数据
3. avformat_find_stream_info#获取流信息
4. 针对每个stream处理
    - pFormatContext->nb_streams
    - avcodec_find_decoder 	#根据流中的编码参数AVCodecParameters，查找是否支持该编码
    - 判断流的类型 pLocalCodecParameters->codec_type
    - 保存AVCodecParameters和AVCodec，用于后续处理
    
9. av_read_frame			#读取一包AVPacket数据包
```
## AVCodec：编解码
### 解码
```shell
5. avcodec_alloc_context3 		#编解码结构体分配内存
6. avcodec_parameters_to_context#将解封装得到的编码参数AVCodecParameters赋值给编解码结构体
7. avcodec_open2 				#打开编码器

10. avcodec_send_packet 		#将解封装中得到的AVPacket数据包送给解码器

12. avcodec_receive_frame 		#读回一帧解码后的数据AVFrame
```
### AVPacket：压缩的数据包
```shell
8. av_packet_alloc 		#压缩的数据包分配内存
```
## swscale：视频图像转换
```shell
13. sws_getContext 		#给SwsContext结构体分配内存

15. sws_scale 			#视频图像转换
```
## AVUtil :工具类

### AVFrame：解码后的数据帧
```shell
11. av_frame_alloc 		#解码后的数据帧分配内存
```
### image
```shell
14. av_image_alloc 		#分配内存用于存放一张图片
```
# 项目
使用qt主要是方便学习ffmpeg编解码，后续采用glfw和sdl显示

## 源码地址
https://github.com/xuleilx/MediaPlayer/tree/main/qt

## 功能描述
1. 使用FFMpeg解码
2. 将FFMpeg解码后的yuv数据转换成rgb
3. 使用QT的QLabel组件，通过QImage显示rgb数据
